#!/usr/bin/env python3
"""
HiBob Employee Search TUI
"""

import sys
import json
import subprocess
import requests
from datetime import datetime
from pathlib import Path
from concurrent.futures import ThreadPoolExecutor

try:
    from textual.app import App, ComposeResult
    from textual.widgets import Input, ListView, ListItem, Static, Label
    from textual.containers import Container
    from textual.binding import Binding
    from rich.panel import Panel
    from rich import box
except ImportError:
    print("Error: 'textual' library not installed. Run: pip install textual")
    sys.exit(1)

CONFIG_PATH = Path.home() / ".config" / "hibob" / "credentials"
CACHE_PATH = Path.home() / ".cache" / "hibob" / "employees.json"
API_BASE = "https://api.hibob.com/v1"


def load_cache():
    if not CACHE_PATH.exists():
        return None
    try:
        with open(CACHE_PATH) as f:
            return json.load(f)
    except:
        return None


def save_cache(employees, lists):
    CACHE_PATH.parent.mkdir(parents=True, exist_ok=True)
    data = {
        "timestamp": datetime.now().isoformat(),
        "employees": employees,
        "lists": lists,
    }
    with open(CACHE_PATH, "w") as f:
        json.dump(data, f)


def fetch_all_data(uid, tok):
    """Fetch employees and lists in parallel."""
    with ThreadPoolExecutor(max_workers=3) as executor:
        emp_future = executor.submit(fetch_all_employees, uid, tok)
        title_future = executor.submit(fetch_named_list, uid, tok, "title")
        dept_future = executor.submit(fetch_named_list, uid, tok, "department")
        employees = emp_future.result()
        lists = {"title": title_future.result(), "dept": dept_future.result()}
    return employees, lists


def load_credentials():
    if not CONFIG_PATH.exists():
        return None, None
    creds = {}
    with open(CONFIG_PATH) as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#") and "=" in line:
                key, value = line.split("=", 1)
                creds[key.strip()] = value.strip()
    user_id = creds.get("HIBOB_SERVICE_USER_ID")
    token = creds.get("HIBOB_SERVICE_USER_TOKEN")
    if not user_id or not token or "your_" in user_id or "your_" in token:
        return None, None
    return user_id, token


def fetch_named_list(user_id, token, list_name):
    url = f"{API_BASE}/company/named-lists/{list_name}"
    response = requests.get(url, auth=(user_id, token))
    if response.status_code != 200:
        return {}
    data = response.json()
    return {str(item.get("id")): item.get("name", "") for item in data.get("values", [])}


def fetch_all_employees(user_id, token):
    url = f"{API_BASE}/people/search"
    payload = {
        "fields": [
            "root.id", "root.displayName", "root.email",
            "work.startDate", "work.reportsTo", "work.title", "work.department"
        ]
    }
    response = requests.post(url, json=payload, auth=(user_id, token),
                            headers={"Content-Type": "application/json"})
    if response.status_code != 200:
        return []
    return response.json().get("employees", [])


def get_field(emp, field):
    if field in emp:
        val = emp[field]
        return val.get("value", "") if isinstance(val, dict) else val
    parts = field.split(".")
    obj = emp
    for part in parts:
        obj = obj.get(part, {}) if isinstance(obj, dict) else ""
    return obj.get("value", "") if isinstance(obj, dict) else (obj or "")


def calc_tenure(start_date):
    if not start_date:
        return "Unknown"
    try:
        delta = datetime.now() - datetime.strptime(start_date, "%Y-%m-%d")
        years, months = delta.days // 365, (delta.days % 365) // 30
        if years > 0:
            return f"{years}y {months}m" if months else f"{years}y"
        return f"{months}m" if months else f"{delta.days}d"
    except ValueError:
        return "Unknown"


def find_manager(emp, all_emps):
    reports_to = emp.get("work", {}).get("reportsTo") or emp.get("reportsTo")
    if not reports_to:
        reports_to = emp.get("/work/reportsTo", {}).get("value") if isinstance(emp.get("/work/reportsTo"), dict) else None
    if not reports_to:
        return None, None
    if isinstance(reports_to, dict):
        mgr_id, mgr_email = reports_to.get("id"), reports_to.get("email")
        for e in all_emps:
            if e.get("id") == mgr_id or get_field(e, "email") == mgr_email:
                return e, get_field(e, "displayName")
        return None, reports_to.get("displayName")
    for e in all_emps:
        if e.get("id") == reports_to or get_field(e, "email") == reports_to:
            return e, get_field(e, "displayName")
    return None, None


def find_reports(emp, all_emps):
    emp_id, emp_email = emp.get("id", ""), get_field(emp, "email")
    reports = []
    for e in all_emps:
        rt = e.get("work", {}).get("reportsTo") or e.get("reportsTo")
        if not rt:
            rt = e.get("/work/reportsTo", {}).get("value") if isinstance(e.get("/work/reportsTo"), dict) else None
        if not rt:
            continue
        if isinstance(rt, dict):
            if rt.get("id") == emp_id or rt.get("email") == emp_email:
                reports.append(e)
        elif rt == emp_id or rt == emp_email:
            reports.append(e)
    return sorted(reports, key=lambda x: get_field(x, "displayName") or "")


def copy_to_clipboard(text):
    try:
        subprocess.Popen(["wl-copy", "--", text], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        return True
    except:
        try:
            p = subprocess.Popen(["xclip", "-selection", "clipboard"], stdin=subprocess.PIPE,
                                stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            p.communicate(text.encode())
            return True
        except:
            return False


class SearchInput(Input):
    BINDINGS = [Binding("tab", "submit", show=False)]


class EmpList(ListView):
    BINDINGS = [Binding("j", "cursor_down", show=False), Binding("k", "cursor_up", show=False)]


class EmpItem(ListItem):
    def __init__(self, emp, title=""):
        super().__init__()
        self.emp = emp
        self.title = title

    def compose(self):
        name = get_field(self.emp, "displayName") or "Unknown"
        yield Label(f"{name}\n[dim]{self.title}[/dim]" if self.title else name)


class HiBobApp(App):
    TITLE = "HiBob Search"
    CSS = """
    $hibob-red: #E8164F;
    $hibob-wine: #83143D;
    $hibob-orange: #FFA32B;
    $hibob-text: #3A3A37;
    $hibob-light: #FAC7D1;

    Screen {
        layout: grid;
        grid-size: 2 4;
        grid-columns: 1fr 2fr;
        grid-rows: auto auto 1fr auto;
        background: #1a1a1a;
    }
    #header {
        column-span: 2;
        height: auto;
        padding: 1 2;
        background: $hibob-red;
    }
    #header-content {
        width: 100%;
    }
    #search {
        column-span: 2;
        padding: 1 2;
        background: #252525;
    }
    #search-input {
        width: 100%;
        border: tall $hibob-red;
        background: #1a1a1a;
    }
    #search-input:focus {
        border: tall $hibob-orange;
    }
    #list-box {
        border: round $hibob-red;
        margin: 0 1 0 1;
        background: #1a1a1a;
    }
    #emp-list { height: 100%; scrollbar-gutter: stable; }
    #detail-box {
        border: round $hibob-wine;
        margin: 0 1 0 0;
        padding: 1 2;
        background: #1a1a1a;
    }
    #detail { height: auto; }
    #reports-title {
        padding: 1 0 0 0;
        text-style: bold;
        color: $hibob-orange;
    }
    #reports { height: 1fr; scrollbar-gutter: stable; }
    #status {
        column-span: 2;
        padding: 0 2;
        background: #252525;
        color: #888888;
    }
    EmpItem { padding: 0 1; height: auto; }
    EmpItem:hover { background: $hibob-wine 30%; }
    EmpItem.-active { background: $hibob-red 40%; }
    EmpItem:focus { background: $hibob-red 40%; }
    """

    BINDINGS = [
        Binding("q", "quit", "Quit"),
        Binding("/", "search", "Search"),
        Binding("escape", "search", show=False),
        Binding("tab", "switch", "Switch"),
        Binding("backspace", "back", "Back"),
        Binding("m", "manager", "Manager"),
        Binding("c", "copy_email", "Copy Email"),
        Binding("n", "copy_name", "Copy Name"),
        Binding("r", "refresh", "Refresh"),
        Binding("ctrl+c", "quit", show=False),
    ]

    def __init__(self):
        super().__init__()
        self.all_emps = []
        self.filtered = []
        self.lists = {}
        self.history = []
        self.current = None
        self.cache_time = None

    def compose(self):
        yield Container(
            Static("[bold white]HiBob Employee Search[/bold white]", id="header-content"),
            id="header"
        )
        yield Container(SearchInput(placeholder="Search...", id="search-input"), id="search")
        yield Container(EmpList(id="emp-list"), id="list-box")
        yield Container(
            Static(id="detail"),
            Static("[bold]Direct Reports[/bold]", id="reports-title"),
            EmpList(id="reports"),
            id="detail-box"
        )
        yield Static("Loading...", id="status")

    def on_mount(self):
        self.load_data()

    def load_data(self, force_refresh=False):
        status = self.query_one("#status", Static)
        uid, tok = load_credentials()
        if not uid:
            status.update("[red]Error:[/red] Configure ~/.config/hibob/credentials")
            return

        # Try cache first unless forcing refresh
        if not force_refresh:
            cache = load_cache()
            if cache:
                self.all_emps = cache.get("employees", [])
                self.lists = cache.get("lists", {})
                try:
                    self.cache_time = datetime.fromisoformat(cache.get("timestamp", ""))
                except:
                    self.cache_time = None
                self._process_employees()
                return

        status.update("Loading from API...")
        try:
            self.all_emps, self.lists = fetch_all_data(uid, tok)
            save_cache(self.all_emps, self.lists)
            self.cache_time = datetime.now()
            self._process_employees()
        except Exception as ex:
            status.update(f"[red]Error:[/red] {ex}")

    def _process_employees(self):
        for e in self.all_emps:
            t = get_field(e, "work.title") or get_field(e, "title") or ""
            e["_title"] = self.lists.get("title", {}).get(str(t), "")
        self.filtered = self.all_emps
        self.refresh_list()
        self.update_status()

    def update_status(self):
        q = self.query_one("#search-input", SearchInput).value.strip()
        n = len(self.filtered) if q else len(self.all_emps)
        label = "matches" if q else "employees"

        # Calculate cache age
        cache_info = ""
        if self.cache_time:
            age = datetime.now() - self.cache_time
            if age.days > 0:
                cache_info = f" [dim](cached {age.days}d ago)[/dim]"
            elif age.seconds >= 3600:
                cache_info = f" [dim](cached {age.seconds // 3600}h ago)[/dim]"
            elif age.seconds >= 60:
                cache_info = f" [dim](cached {age.seconds // 60}m ago)[/dim]"
            else:
                cache_info = " [dim](just updated)[/dim]"

        hints = "/ Search  Tab Switch  m Manager  c Email  n Name  r Refresh"
        if self.history:
            hints += "  ⌫ Back"
        self.query_one("#status", Static).update(f"[green]{n} {label}[/green]{cache_info} │ [dim]{hints}  q Quit[/dim]")

    def refresh_list(self):
        lst = self.query_one("#emp-list", EmpList)
        lst.clear()
        for e in self.filtered[:100]:
            lst.append(EmpItem(e, e.get("_title", "")))

    def refresh_reports(self):
        lst = self.query_one("#reports", EmpList)
        lst.clear()
        title = self.query_one("#reports-title", Static)
        if not self.current:
            title.update("[bold]Direct Reports[/bold]")
            return
        reports = find_reports(self.current, self.all_emps)
        title.update(f"[bold]Direct Reports[/bold] ({len(reports)})" if reports else "[bold]Direct Reports[/bold] [dim](none)[/dim]")
        for e in reports:
            lst.append(EmpItem(e, self.lists["title"].get(str(get_field(e, "work.title") or ""), "")))

    def show_employee(self, emp, add_history=True):
        if add_history and self.current:
            self.history.append(self.current)
        self.current = emp
        self.refresh_detail()
        self.refresh_reports()
        self.update_status()

    def refresh_detail(self):
        detail = self.query_one("#detail", Static)
        if not self.current:
            detail.update("[dim]Select an employee[/dim]")
            return
        e = self.current
        name = get_field(e, "displayName") or "Unknown"
        email = get_field(e, "email") or ""
        title = self.lists["title"].get(str(get_field(e, "work.title") or get_field(e, "title") or ""), "")
        dept = self.lists["dept"].get(str(get_field(e, "work.department") or get_field(e, "department") or ""), "")
        tenure = calc_tenure(get_field(e, "work.startDate") or get_field(e, "startDate") or "")
        _, mgr_name = find_manager(e, self.all_emps)

        lines = [f"[bold]{name}[/bold]", ""]
        if email:
            lines.append(f"[dim]Email[/dim]     [cyan]{email}[/cyan]")
        if title:
            lines.append(f"[dim]Title[/dim]     {title}")
        if dept:
            lines.append(f"[dim]Dept[/dim]      {dept}")
        lines.append(f"[dim]Tenure[/dim]    {tenure}")
        lines.append(f"[dim]Manager[/dim]   {mgr_name or 'None'}")
        detail.update("\n".join(lines))

    def on_input_changed(self, event):
        q = event.value.lower().strip()
        self.filtered = [e for e in self.all_emps if q in (get_field(e, "displayName") or "").lower() or q in (get_field(e, "email") or "").lower()] if q else self.all_emps
        self.refresh_list()
        self.update_status()

    def on_input_submitted(self, event):
        emp_list = self.query_one("#emp-list", EmpList)
        emp_list.focus()
        # Auto-select first item
        if emp_list.children:
            emp_list.index = 0
            first = emp_list.children[0]
            if isinstance(first, EmpItem):
                self.show_employee(first.emp)

    def on_list_view_highlighted(self, event):
        if isinstance(event.item, EmpItem) and event.list_view.id == "emp-list":
            self.show_employee(event.item.emp, add_history=False)

    def on_list_view_selected(self, event):
        if isinstance(event.item, EmpItem):
            self.show_employee(event.item.emp)
            if event.list_view.id == "reports":
                self.query_one("#reports", EmpList).focus()

    def action_search(self):
        self.query_one("#search-input", SearchInput).focus()

    def action_switch(self):
        emp_list = self.query_one("#emp-list", EmpList)
        reports = self.query_one("#reports", EmpList)
        (reports if emp_list.has_focus else emp_list).focus()

    def action_back(self):
        if self.history:
            self.current = self.history.pop()
            self.refresh_detail()
            self.refresh_reports()
            self.update_status()

    def action_manager(self):
        if self.current:
            mgr, _ = find_manager(self.current, self.all_emps)
            if mgr:
                self.show_employee(mgr)

    def action_copy_email(self):
        if self.current:
            email = get_field(self.current, "email")
            if email and copy_to_clipboard(email):
                self.query_one("#status", Static).update(f"[green]Copied:[/green] {email}")

    def action_copy_name(self):
        if self.current:
            name = get_field(self.current, "displayName")
            if name and copy_to_clipboard(name):
                self.query_one("#status", Static).update(f"[green]Copied:[/green] {name}")

    def action_refresh(self):
        self.load_data(force_refresh=True)


def main():
    if len(sys.argv) > 1:
        from rich.console import Console
        query = " ".join(sys.argv[1:])
        uid, tok = load_credentials()
        if not uid:
            print("Error: Configure ~/.config/hibob/credentials")
            sys.exit(1)
        console = Console()
        with console.status(f"Searching '{query}'..."):
            emps = fetch_all_employees(uid, tok)
            lists = {"title": fetch_named_list(uid, tok, "title"), "dept": fetch_named_list(uid, tok, "department")}
        matches = [e for e in emps if query.lower() in (get_field(e, "displayName") or "").lower() or query.lower() in (get_field(e, "email") or "").lower()]
        if not matches:
            console.print(f"[yellow]No matches for '{query}'[/yellow]")
            sys.exit(0)
        console.print(f"\n[green]Found {len(matches)}[/green]\n")
        for e in matches:
            name = get_field(e, "displayName") or "Unknown"
            email = get_field(e, "email") or ""
            title = lists["title"].get(str(get_field(e, "work.title") or ""), "")
            dept = lists["dept"].get(str(get_field(e, "work.department") or ""), "")
            tenure = calc_tenure(get_field(e, "work.startDate") or "")
            _, mgr = find_manager(e, emps)
            reports = [get_field(r, "displayName") for r in find_reports(e, emps)]
            lines = [f"[cyan]Email:[/cyan] {email}"]
            if title: lines.append(f"[cyan]Title:[/cyan] {title}")
            if dept: lines.append(f"[cyan]Dept:[/cyan] {dept}")
            lines.append(f"[cyan]Tenure:[/cyan] {tenure}")
            lines.append(f"[cyan]Manager:[/cyan] {mgr or 'None'}")
            if reports:
                lines.append(f"[cyan]Reports:[/cyan] ({len(reports)})")
                lines.extend(f"  • {r}" for r in reports)
            console.print(Panel("\n".join(lines), title=f"[bold]{name}[/bold]", box=box.ROUNDED))
            console.print()
    else:
        HiBobApp().run()


if __name__ == "__main__":
    main()
