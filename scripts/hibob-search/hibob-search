#!/usr/bin/env python3
"""
HiBob Employee Search TUI

Interactive terminal interface for searching employees.
"""

import sys
import os
import requests
from datetime import datetime
from pathlib import Path

try:
    from textual.app import App, ComposeResult
    from textual.widgets import Header, Footer, Input, ListView, ListItem, Static, Label
    from textual.containers import Horizontal, Vertical, Container
    from textual.binding import Binding
    from textual import events
    from rich.text import Text
    from rich.panel import Panel
    from rich import box
except ImportError:
    print("Error: 'textual' library not installed. Run: pip install textual")
    sys.exit(1)

CONFIG_PATH = Path.home() / ".config" / "hibob" / "credentials"
API_BASE = "https://api.hibob.com/v1"


def load_credentials():
    """Load API credentials from config file."""
    if not CONFIG_PATH.exists():
        return None, None

    creds = {}
    with open(CONFIG_PATH) as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#") and "=" in line:
                key, value = line.split("=", 1)
                creds[key.strip()] = value.strip()

    user_id = creds.get("HIBOB_SERVICE_USER_ID")
    token = creds.get("HIBOB_SERVICE_USER_TOKEN")

    if not user_id or not token or "your_" in user_id or "your_" in token:
        return None, None

    return user_id, token


def fetch_named_list(user_id, token, list_name):
    """Fetch a named list from HiBob and return ID->name mapping."""
    url = f"{API_BASE}/company/named-lists/{list_name}"
    response = requests.get(url, auth=(user_id, token))
    if response.status_code != 200:
        return {}
    data = response.json()
    return {str(item.get("id")): item.get("name", "") for item in data.get("values", [])}


def fetch_all_employees(user_id, token):
    """Fetch all employees from HiBob."""
    url = f"{API_BASE}/people/search"
    payload = {
        "fields": [
            "root.id",
            "root.displayName",
            "root.email",
            "work.startDate",
            "work.reportsTo",
            "work.title",
            "work.department"
        ]
    }
    response = requests.post(
        url,
        json=payload,
        auth=(user_id, token),
        headers={"Content-Type": "application/json"}
    )
    if response.status_code != 200:
        return []
    return response.json().get("employees", [])


def get_field(employee, field):
    """Get a field value handling both flat and nested response formats."""
    if field in employee:
        val = employee[field]
        if isinstance(val, dict):
            return val.get("value", "")
        return val
    parts = field.split(".")
    obj = employee
    for part in parts:
        if isinstance(obj, dict):
            obj = obj.get(part, {})
        else:
            return ""
    if isinstance(obj, dict):
        return obj.get("value", "")
    return obj if obj else ""


def calculate_tenure(start_date_str):
    """Calculate tenure from start date."""
    if not start_date_str:
        return "Unknown"
    try:
        start_date = datetime.strptime(start_date_str, "%Y-%m-%d")
        today = datetime.now()
        delta = today - start_date
        years = delta.days // 365
        months = (delta.days % 365) // 30
        if years > 0:
            if months > 0:
                return f"{years}y {months}m"
            return f"{years}y"
        elif months > 0:
            return f"{months}m"
        else:
            return f"{delta.days}d"
    except ValueError:
        return "Unknown"


def find_manager(employee, all_employees):
    """Find the manager's name for an employee."""
    reports_to = employee.get("work", {}).get("reportsTo") or employee.get("reportsTo")
    if not reports_to:
        wrapped = employee.get("/work/reportsTo", {})
        if isinstance(wrapped, dict):
            reports_to = wrapped.get("value")
    if not reports_to:
        return None
    if isinstance(reports_to, dict):
        return reports_to.get("displayName") or reports_to.get("email") or str(reports_to)
    for emp in all_employees:
        emp_id = emp.get("id", "")
        emp_email = get_field(emp, "email")
        if reports_to == emp_id or reports_to == emp_email:
            return get_field(emp, "displayName") or reports_to
    return reports_to


def find_direct_reports(employee, all_employees):
    """Find direct reports for an employee."""
    emp_id = employee.get("id", "")
    emp_email = get_field(employee, "email")
    reports = []
    for emp in all_employees:
        reports_to = emp.get("work", {}).get("reportsTo") or emp.get("reportsTo")
        if not reports_to:
            wrapped = emp.get("/work/reportsTo", {})
            if isinstance(wrapped, dict):
                reports_to = wrapped.get("value")
        if not reports_to:
            continue
        if isinstance(reports_to, dict):
            manager_id = reports_to.get("id", "")
            manager_email = reports_to.get("email", "")
            if manager_id == emp_id or manager_email == emp_email:
                name = get_field(emp, "displayName") or "Unknown"
                reports.append(name)
        elif reports_to == emp_id or reports_to == emp_email:
            name = get_field(emp, "displayName") or "Unknown"
            reports.append(name)
    return sorted(reports)


class EmployeeList(ListView):
    """Custom ListView for employees with vim bindings."""

    BINDINGS = [
        Binding("j", "cursor_down", "Down", show=False),
        Binding("k", "cursor_up", "Up", show=False),
    ]


class EmployeeItem(ListItem):
    """A list item representing an employee."""

    def __init__(self, employee: dict, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.employee = employee

    def compose(self) -> ComposeResult:
        name = get_field(self.employee, "displayName") or "Unknown"
        title = self.employee.get("_resolved_title", "")
        if title:
            yield Label(f"{name}\n[dim]{title}[/dim]")
        else:
            yield Label(name)


class EmployeeDetail(Static):
    """Panel showing employee details."""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.employee = None
        self.all_employees = []
        self.lists = {}

    def set_employee(self, employee, all_employees, lists):
        """Update the displayed employee."""
        self.employee = employee
        self.all_employees = all_employees
        self.lists = lists
        self.refresh_display()

    def clear(self):
        """Clear the display."""
        self.employee = None
        self.update("[dim]Select an employee to view details[/dim]")

    def refresh_display(self):
        """Refresh the employee detail display."""
        if not self.employee:
            self.update("[dim]Select an employee to view details[/dim]")
            return

        emp = self.employee
        name = get_field(emp, "displayName") or "Unknown"
        email = get_field(emp, "email") or "Unknown"

        title_raw = get_field(emp, "work.title") or get_field(emp, "title") or ""
        department_raw = get_field(emp, "work.department") or get_field(emp, "department") or ""

        title = self.lists.get("title", {}).get(str(title_raw), title_raw) if title_raw else ""
        department = self.lists.get("department", {}).get(str(department_raw), department_raw) if department_raw else ""

        start_date = get_field(emp, "work.startDate") or get_field(emp, "startDate") or ""
        tenure = calculate_tenure(start_date)

        manager = find_manager(emp, self.all_employees)
        direct_reports = find_direct_reports(emp, self.all_employees)

        lines = [f"[bold cyan]{name}[/bold cyan]\n"]
        lines.append(f"[bold]Email:[/bold] {email}")
        if title:
            lines.append(f"[bold]Title:[/bold] {title}")
        if department:
            lines.append(f"[bold]Department:[/bold] {department}")
        lines.append(f"[bold]Tenure:[/bold] {tenure}")

        if manager:
            lines.append(f"[bold]Reports to:[/bold] {manager}")
        else:
            lines.append(f"[bold]Reports to:[/bold] [dim]None (top level)[/dim]")

        if direct_reports:
            lines.append(f"\n[bold]Direct reports:[/bold] ({len(direct_reports)})")
            for report in direct_reports[:15]:  # Limit to 15
                lines.append(f"  [dim]•[/dim] {report}")
            if len(direct_reports) > 15:
                lines.append(f"  [dim]... and {len(direct_reports) - 15} more[/dim]")
        else:
            lines.append(f"\n[bold]Direct reports:[/bold] [dim]None[/dim]")

        self.update("\n".join(lines))


class HiBobApp(App):
    """HiBob Employee Search TUI Application."""

    CSS = """
    Screen {
        layout: grid;
        grid-size: 2 3;
        grid-columns: 1fr 1fr;
        grid-rows: auto 1fr auto;
    }

    #search-container {
        column-span: 2;
        height: auto;
        padding: 1;
    }

    #search-input {
        width: 100%;
    }

    #employee-list-container {
        height: 100%;
        border: solid $primary;
        padding: 0 1;
    }

    #employee-list {
        height: 100%;
    }

    #detail-container {
        height: 100%;
        border: solid $secondary;
        padding: 1;
    }

    #status-bar {
        column-span: 2;
        height: auto;
        padding: 0 1;
        background: $surface;
    }

    EmployeeItem {
        padding: 0 1;
    }

    EmployeeItem:hover {
        background: $boost;
    }

    EmployeeItem.-active {
        background: $accent;
    }
    """

    BINDINGS = [
        Binding("q", "quit", "Quit"),
        Binding("escape", "focus_search", "Search", show=False),
        Binding("/", "focus_search", "Search"),
        Binding("ctrl+c", "quit", "Quit", show=False),
    ]

    def __init__(self):
        super().__init__()
        self.all_employees = []
        self.filtered_employees = []
        self.lists = {}
        self.user_id = None
        self.token = None

    def compose(self) -> ComposeResult:
        yield Container(
            Input(placeholder="Search employees...", id="search-input"),
            id="search-container"
        )
        yield Container(
            EmployeeList(id="employee-list"),
            id="employee-list-container"
        )
        yield Container(
            EmployeeDetail(id="employee-detail"),
            id="detail-container"
        )
        yield Static("Loading...", id="status-bar")

    def on_mount(self) -> None:
        """Load data when app starts."""
        self.load_data()

    def load_data(self) -> None:
        """Load employees from HiBob."""
        status = self.query_one("#status-bar", Static)

        self.user_id, self.token = load_credentials()
        if not self.user_id or not self.token:
            status.update("[red]Error:[/red] Credentials not configured. Edit ~/.config/hibob/credentials")
            return

        status.update("Fetching employees...")

        try:
            self.all_employees = fetch_all_employees(self.user_id, self.token)
            self.lists = {
                "title": fetch_named_list(self.user_id, self.token, "title"),
                "department": fetch_named_list(self.user_id, self.token, "department"),
            }

            # Pre-resolve titles for list display
            for emp in self.all_employees:
                title_raw = get_field(emp, "work.title") or get_field(emp, "title") or ""
                emp["_resolved_title"] = self.lists.get("title", {}).get(str(title_raw), "")

            self.filtered_employees = self.all_employees
            self.update_list()
            status.update(f"[green]{len(self.all_employees)} employees[/green] | [dim]/ Search  j/k Navigate  Enter Select  q Quit[/dim]")

        except Exception as e:
            status.update(f"[red]Error:[/red] {str(e)}")

    def update_list(self) -> None:
        """Update the employee list."""
        list_view = self.query_one("#employee-list", EmployeeList)
        list_view.clear()
        for emp in self.filtered_employees[:100]:  # Limit to 100 for performance
            list_view.append(EmployeeItem(emp))

    def on_input_changed(self, event: Input.Changed) -> None:
        """Handle search input changes."""
        query = event.value.lower().strip()
        if not query:
            self.filtered_employees = self.all_employees
        else:
            self.filtered_employees = [
                emp for emp in self.all_employees
                if query in (get_field(emp, "displayName") or "").lower()
                or query in (get_field(emp, "email") or "").lower()
            ]
        self.update_list()

        status = self.query_one("#status-bar", Static)
        if query:
            status.update(f"[green]{len(self.filtered_employees)} matches[/green] | [dim]/ Search  j/k Navigate  Enter Select  q Quit[/dim]")
        else:
            status.update(f"[green]{len(self.all_employees)} employees[/green] | [dim]/ Search  j/k Navigate  Enter Select  q Quit[/dim]")

    def on_list_view_selected(self, event: ListView.Selected) -> None:
        """Handle employee selection."""
        if isinstance(event.item, EmployeeItem):
            detail = self.query_one("#employee-detail", EmployeeDetail)
            detail.set_employee(event.item.employee, self.all_employees, self.lists)

    def on_list_view_highlighted(self, event: ListView.Highlighted) -> None:
        """Handle employee highlight (cursor movement)."""
        if isinstance(event.item, EmployeeItem):
            detail = self.query_one("#employee-detail", EmployeeDetail)
            detail.set_employee(event.item.employee, self.all_employees, self.lists)

    def action_focus_search(self) -> None:
        """Focus the search input."""
        self.query_one("#search-input", Input).focus()

    def on_input_submitted(self, event: Input.Submitted) -> None:
        """Handle Enter in search - focus the list."""
        list_view = self.query_one("#employee-list", EmployeeList)
        list_view.focus()


def main():
    # Check for command line argument for non-interactive mode
    if len(sys.argv) > 1:
        # Fall back to simple mode
        query = " ".join(sys.argv[1:])
        user_id, token = load_credentials()
        if not user_id or not token:
            print("Error: Credentials not configured. Edit ~/.config/hibob/credentials")
            sys.exit(1)

        from rich.console import Console
        from rich.panel import Panel
        from rich import box

        console = Console()
        with console.status(f"Searching for '{query}'..."):
            all_employees = fetch_all_employees(user_id, token)
            lists = {
                "title": fetch_named_list(user_id, token, "title"),
                "department": fetch_named_list(user_id, token, "department"),
            }

        query_lower = query.lower()
        matches = [
            emp for emp in all_employees
            if query_lower in (get_field(emp, "displayName") or "").lower()
            or query_lower in (get_field(emp, "email") or "").lower()
        ]

        if not matches:
            console.print(f"[yellow]No employees found matching '{query}'[/yellow]")
            sys.exit(0)

        console.print(f"\n[green]Found {len(matches)} employee(s)[/green]\n")
        for emp in matches:
            name = get_field(emp, "displayName") or "Unknown"
            email = get_field(emp, "email") or "Unknown"
            title_raw = get_field(emp, "work.title") or get_field(emp, "title") or ""
            department_raw = get_field(emp, "work.department") or get_field(emp, "department") or ""
            title = lists.get("title", {}).get(str(title_raw), title_raw) if title_raw else ""
            department = lists.get("department", {}).get(str(department_raw), department_raw) if department_raw else ""
            start_date = get_field(emp, "work.startDate") or get_field(emp, "startDate") or ""
            tenure = calculate_tenure(start_date)
            manager = find_manager(emp, all_employees)
            direct_reports = find_direct_reports(emp, all_employees)

            lines = []
            lines.append(f"[bold cyan]Email:[/bold cyan] {email}")
            if title:
                lines.append(f"[bold cyan]Title:[/bold cyan] {title}")
            if department:
                lines.append(f"[bold cyan]Department:[/bold cyan] {department}")
            lines.append(f"[bold cyan]Tenure:[/bold cyan] {tenure}")
            if manager:
                lines.append(f"[bold cyan]Reports to:[/bold cyan] {manager}")
            else:
                lines.append(f"[bold cyan]Reports to:[/bold cyan] [dim]None (top level)[/dim]")
            if direct_reports:
                lines.append(f"[bold cyan]Direct reports:[/bold cyan] ({len(direct_reports)})")
                for report in direct_reports:
                    lines.append(f"  [dim]•[/dim] {report}")
            else:
                lines.append(f"[bold cyan]Direct reports:[/bold cyan] [dim]None[/dim]")

            console.print(Panel("\n".join(lines), title=f"[bold white]{name}[/bold white]", box=box.ROUNDED, padding=(1, 2)))
            console.print()
    else:
        # Interactive TUI mode
        app = HiBobApp()
        app.run()


if __name__ == "__main__":
    main()
